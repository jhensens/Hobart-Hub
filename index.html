<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venue Manager Pro | Hobart Secure Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .stats-card { background: white; border-radius: 1.25rem; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* Fixed Form Layout to prevent text overlapping */
        .form-section-title { font-size: 1.25rem; font-weight: 900; text-transform: uppercase; font-style: italic; letter-spacing: -0.05em; color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 0.75rem; margin-bottom: 1.5rem; }
        .input-group { display: block; margin-bottom: 1.25rem; width: 100%; }
        .input-group label { display: block; font-weight: 800; color: #1e293b; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; line-height: 1; margin-bottom: 2px; }
        .input-group .sub-label { display: block; font-size: 0.6rem; color: #64748b; font-weight: 500; margin-bottom: 0.5rem; line-height: 1.2; }
        .input-group input, .input-group select, .input-group textarea { display: block; border-radius: 0.75rem; padding: 0.75rem 1rem; border: 1px solid #d1d5db; width: 100%; outline: none; font-size: 0.9rem; font-weight: 600; background: #fff; box-sizing: border-box; }
        .input-group input:focus { border-color: #2563eb; ring: 2px; ring-color: #dbeafe; }
        
        .category-tab.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .category-tab.review-tab { border: 2px dashed #f59e0b; color: #b45309; font-weight: 900; }
        .category-tab.review-tab.active { background-color: #f59e0b; color: white; border-style: solid; }
        .low-stock-row { border-left: 6px solid #ef4444 !important; background-color: #fef2f2; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .math-helper { background: #eff6ff; border: 1px solid #bfdbfe; padding: 0.75rem; border-radius: 0.75rem; font-size: 0.7rem; color: #1e40af; font-weight: 600; margin-top: 1rem; }
        .modal-bg { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); }
        .batch-row:nth-child(even) { background-color: #f8fafc; }
    </style>
</head>
<body class="min-h-screen pb-20 text-slate-900">

    <!-- AUTH LAYER -->
    <div id="login-screen" class="fixed inset-0 z-[200] bg-slate-900 flex items-center justify-center p-6">
        <div class="max-w-sm w-full bg-white rounded-[2.5rem] p-10 shadow-2xl">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center text-white text-2xl shadow-lg">üîê</div>
            <h2 id="auth-title" class="text-xl font-black text-slate-900 mb-6 text-center uppercase tracking-tighter">Venue Terminal</h2>
            <div class="space-y-4">
                <div class="input-group"><label>Email</label><input type="email" id="auth-email" placeholder="admin@hobart.com"></div>
                <div class="input-group"><label>Password</label><input type="password" id="auth-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button onclick="window.handleAuth()" id="auth-btn" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl uppercase text-xs tracking-widest hover:bg-blue-700 transition">Sign In</button>
                <div class="text-center mt-6"><button onclick="window.toggleAuthMode()" id="auth-toggle" class="text-[10px] font-black text-slate-400 uppercase tracking-widest hover:text-blue-600 transition">Create New Account</button></div>
                <p id="auth-err" class="text-red-500 text-[10px] font-black mt-4 uppercase text-center hidden p-3 bg-red-50 rounded-xl border border-red-100"></p>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-content" class="hidden">
        <div class="max-w-[1600px] mx-auto px-4 md:px-8 pt-8">
            <header class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-10 gap-6">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tighter italic">Venue Manager <span class="text-blue-600">Pro</span></h1>
                    <div class="flex items-center gap-3">
                        <span id="cloud-status" class="text-[10px] font-black uppercase text-emerald-600 tracking-widest">üì° CONNECTED</span>
                        <button onclick="window.logout()" class="text-[10px] font-black uppercase text-slate-400 hover:text-red-500 transition">Sign Out</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button onclick="document.getElementById('invoice-upload').click()" class="bg-indigo-600 text-white font-black py-3 px-6 rounded-2xl text-xs uppercase shadow-xl hover:scale-105 transition">Scan Invoice</button>
                    <input type="file" id="invoice-upload" accept="image/*,.pdf" multiple class="hidden" onchange="window.handleInvoiceUpload(event)">
                    <button onclick="window.toggleStocktake()" class="bg-slate-800 text-white font-black py-3 px-6 rounded-2xl text-xs uppercase shadow-xl">Stocktake</button>
                    <button onclick="window.toggleSettings()" class="bg-white border border-slate-200 text-slate-700 font-black py-3 px-6 rounded-2xl text-xs uppercase shadow-md hover:bg-slate-50 transition">Settings</button>
                </div>
            </header>

            <div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-4 mb-8">
                <div class="stats-card"><div class="text-[10px] font-black text-slate-400 uppercase mb-1">Stock Value</div><div id="stat-value" class="text-2xl font-black text-slate-800">$0.00</div></div>
                <div onclick="window.setCategory('Inbox')" class="stats-card border-l-4 border-amber-500 cursor-pointer bg-amber-50 group">
                    <div class="text-[10px] font-black text-amber-600 uppercase mb-1 flex justify-between"><span>Inbox</span><span class="group-hover:translate-x-1 transition">‚ûî</span></div>
                    <div id="stat-review" class="text-2xl font-black text-amber-700">0</div>
                </div>
                <div class="stats-card border-l-4 border-red-500"><div class="text-[10px] font-black text-red-400 uppercase mb-1">Low Stock</div><div id="stat-low" class="text-2xl font-black text-red-600">0</div></div>
                <div class="stats-card"><div class="text-[10px] font-black text-emerald-600 uppercase mb-1">Total Items</div><div id="stat-total" class="text-xl font-black text-emerald-700">0</div></div>
                <button onclick="window.generateReorderList()" class="bg-blue-600 text-white font-black rounded-2xl text-[10px] uppercase p-2 shadow-lg hover:bg-blue-700 transition hidden xl:block">üìã Reorder List</button>
            </div>

            <div id="processing-indicator" class="hidden mb-8 p-6 bg-indigo-600 rounded-[2rem] shadow-2xl animate-pulse flex items-center justify-between text-white">
                <div class="flex items-center gap-4 text-sm font-black italic uppercase tracking-widest">
                    <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span>AI analyzing multi-page invoice...</span>
                </div>
            </div>

            <div id="message-box" class="hidden fixed top-8 right-8 z-[250] p-6 rounded-2xl shadow-2xl text-[10px] font-black uppercase transition-all"></div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <!-- FORM SIDEBAR -->
                <div class="lg:col-span-4 xl:col-span-3">
                    <div class="bg-white rounded-[2.5rem] shadow-xl border border-slate-100 p-8 sticky top-8">
                        <div class="flex justify-between items-center mb-6 border-b pb-4 border-slate-50">
                            <h2 class="text-xl font-black uppercase italic tracking-tighter">Product Setup</h2>
                            <button id="cancel-edit" onclick="window.cancelEdit()" class="hidden text-[10px] font-black text-red-500 uppercase bg-red-50 px-3 py-1 rounded-full transition hover:bg-red-100">Clear</button>
                        </div>
                        <form id="item-form" class="space-y-1">
                            <input type="hidden" id="edit-id">
                            
                            <div class="input-group">
                                <label>Product Name</label>
                                <span class="sub-label">Brand & Description</span>
                                <input type="text" id="item-name" placeholder="e.g. Asahi 330ml" required>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group"><label>SKU / Code</label><span class="sub-label">Barcode</span><input type="text" id="item-sku" required></div>
                                <div class="input-group"><label>Supplier</label><span class="sub-label">Vendor</span><input list="supplier-list" id="item-supplier" placeholder="Vendor..."><datalist id="supplier-list"></datalist></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group"><label>Units in 1 Case</label><span class="sub-label">e.g. 24 per carton</span><input type="number" id="pack-size" step="any" value="1"></div>
                                <div class="input-group"><label>Count As (UoM)</label><span class="sub-label">Label</span><select id="uom-select"><option>Bottle</option><option>Can</option><option>Each</option><option>Kg</option><option>Litre</option><option>Box</option></select></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group"><label>Single Cost ($)</label><span class="sub-label">Price per unit</span><input type="number" id="unit-cost" step="0.01" value="0.00"></div>
                                <div class="input-group"><label>Usage / Week</label><span class="sub-label">Burn rate</span><input type="number" id="weekly-usage" step="any" value="0"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group"><label>Min Stock (Par)</label><span class="sub-label">Target level</span><input type="number" id="reorder-point" step="any" value="5"></div>
                                <div class="input-group"><label>On Hand</label><span class="sub-label">Current count</span><input type="number" id="quantity" step="any" value="0" class="text-blue-600 border-blue-200"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group"><label>Expiry Date</label><span class="sub-label">Optional</span><input type="date" id="expiry-date"></div>
                                <div class="input-group"><label>Category</label><span class="sub-label">Work Group</span><select id="category-select" class="bg-slate-50"></select></div>
                            </div>

                            <div class="input-group"><label>Bin Location</label><span class="sub-label">Shelf spot</span><select id="bin-select"></select></div>
                            <div class="input-group"><label>Notes</label><textarea id="item-notes" rows="2" class="resize-none" placeholder="Storage instructions..."></textarea></div>
                            
                            <div id="math-helper-box" class="math-helper hidden">üí° <span id="math-helper-text"></span></div>
                            
                            <button type="submit" id="submit-btn" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl uppercase text-xs tracking-widest hover:bg-blue-700 transition">Save to Hobart Cloud</button>
                            <button type="button" id="delete-btn" onclick="window.deleteItem()" class="hidden w-full bg-red-50 text-red-600 font-black py-3 rounded-2xl uppercase text-[9px] mt-2 transition hover:bg-red-100">Delete Product</button>
                        </form>
                    </div>
                </div>

                <!-- LIST AREA -->
                <div class="lg:col-span-8 xl:col-span-9">
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 mb-8">
                        <div id="category-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-6 mb-6 border-b border-slate-100"></div>
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="search-bar" oninput="window.renderInventory()" placeholder="Find item..." class="flex-grow p-4 bg-slate-50 border-none rounded-2xl outline-none font-bold text-sm">
                            <select id="supplier-filter" onchange="window.renderInventory()" class="p-4 bg-slate-100 border-none rounded-2xl outline-none font-black text-blue-600 text-[10px] uppercase min-w-[200px] shadow-sm">
                                <option value="all">All Suppliers</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="review-banner" class="hidden mb-6 p-6 bg-amber-50 border border-amber-200 rounded-[2rem] flex flex-col md:flex-row justify-between items-center shadow-md gap-4">
                        <div class="flex items-center gap-4 text-center md:text-left">
                            <span class="text-3xl">üì•</span>
                            <div>
                                <h3 class="font-black text-amber-800 uppercase text-xs tracking-widest italic">Inbox (Invoice Scan Queue)</h3>
                                <p class="text-[10px] font-bold text-amber-600">AI found new items. Review them individually or use the batch table.</p>
                            </div>
                        </div>
                        <button onclick="window.toggleBatchReview()" class="w-full md:w-auto bg-amber-600 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg hover:bg-amber-700 transition">Review All as Table</button>
                    </div>

                    <ul id="inventory-list" class="space-y-4"></ul>
                    <div id="empty-state" class="hidden text-center py-20 text-slate-400 italic font-black uppercase text-xs tracking-widest">No items found.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- BATCH REVIEW TABLE -->
    <div id="batch-modal" class="hidden fixed inset-0 z-[250] flex items-center justify-center modal-bg p-4">
        <div class="bg-white rounded-[3.5rem] p-12 max-w-7xl w-full shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-2xl font-black uppercase italic tracking-tighter">Batch Review</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Speed-processing scanned items</p>
                </div>
                <button onclick="window.toggleBatchReview()" class="text-slate-300 font-black p-2 hover:text-slate-900 transition">‚úï</button>
            </div>
            <div class="overflow-x-auto flex-grow no-scrollbar">
                <table class="w-full text-left border-collapse min-w-[1000px]">
                    <thead class="bg-slate-50 sticky top-0 z-10">
                        <tr class="text-[9px] font-black text-slate-400 uppercase tracking-widest">
                            <th class="p-4">Name</th>
                            <th class="p-4">Code</th>
                            <th class="p-4 w-24">Pack Size</th>
                            <th class="p-4">Category</th>
                            <th class="p-4 w-24">Unit Cost</th>
                            <th class="p-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="batch-table-body"></tbody>
                </table>
            </div>
            <div class="mt-8 pt-8 border-t flex justify-end">
                <button onclick="window.toggleBatchReview()" class="px-10 py-4 bg-blue-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg">Finish Batch</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center modal-bg p-4">
        <div class="bg-white rounded-[3.5rem] p-12 max-w-5xl w-full shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-10"><h3 class="text-2xl font-black uppercase italic tracking-tighter">Venue Setup</h3><button onclick="window.toggleSettings()" class="text-slate-300 font-black p-2 hover:text-slate-900 transition">‚úï</button></div>
            <div class="overflow-y-auto flex-grow no-scrollbar space-y-8">
                <div class="bg-indigo-50 p-8 rounded-3xl border border-indigo-100">
                    <label class="text-[10px] font-black text-indigo-500 uppercase block mb-4 tracking-widest">AI API Key</label>
                    <input type="password" id="api-key-input" onchange="window.saveApiKey()" placeholder="Paste Gemini Key..." class="w-full p-4 rounded-xl border border-indigo-200">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase block mb-4">Venue Categories (Click to rename)</label>
                        <div class="flex gap-2 mb-4"><input type="text" id="new-cat" class="p-3 border rounded-xl flex-grow" placeholder="Add..."><button onclick="window.addConfig('categories', 'new-cat')" class="bg-blue-600 text-white px-5 rounded-xl font-black">+</button></div>
                        <ul id="cat-config-list" class="space-y-2"></ul>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase block mb-4">Storage Bins</label>
                        <div class="flex gap-2 mb-4"><input type="text" id="new-bin" class="p-3 border rounded-xl flex-grow" placeholder="Add..."><button onclick="window.addConfig('bins', 'new-bin')" class="bg-blue-600 text-white px-5 rounded-xl font-black">+</button></div>
                        <ul id="bin-config-list" class="space-y-2"></ul>
                    </div>
                </div>
                <div class="flex gap-4"><button onclick="window.exportData()" class="flex-grow bg-emerald-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg hover:bg-emerald-700 transition">Download Categorized Backup (CSV)</button><button onclick="window.resetDatabase()" class="bg-red-600 text-white py-4 px-8 rounded-2xl font-black text-xs uppercase shadow-lg hover:bg-red-700 transition">üî• Factory Reset</button></div>
            </div>
        </div>
    </div>

    <!-- STOCKTAKE -->
    <div id="stocktake-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center modal-bg p-4">
        <div class="bg-white rounded-[3rem] p-12 max-w-3xl w-full shadow-2xl max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-black mb-6 uppercase italic tracking-tighter text-blue-600">Physical Audit</h3>
            <div id="stocktake-list" class="overflow-y-auto flex-grow space-y-3 mb-8 no-scrollbar"></div>
            <div class="flex gap-4"><button onclick="window.commitStocktake()" class="flex-grow bg-blue-600 text-white font-black py-5 rounded-2xl uppercase text-xs shadow-xl hover:bg-blue-700 transition">Confirm Audit Counts</button><button onclick="window.toggleStocktake()" class="px-10 bg-slate-100 rounded-2xl font-black text-[10px] hover:bg-slate-200 transition">Cancel</button></div>
        </div>
    </div>

    <canvas id="pdf-render-canvas" class="hidden"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvE67VRASfD7Y4LFsbuTq3QqjI6NfoHWk",
            authDomain: "venue-inventory.firebaseapp.com",
            projectId: "venue-inventory",
            storageBucket: "venue-inventory.firebasestorage.app",
            messagingSenderId: "34996096819",
            appId: "1:34996096819:web:9de51ce3b9f51e687d3846"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const venueId = "hobart-main";

        const refs = {
            inv: () => doc(db, 'venues', venueId, 'data', 'inventory'),
            his: () => doc(db, 'venues', venueId, 'data', 'history'),
            cfg: () => doc(db, 'venues', venueId, 'data', 'config')
        };

        window.inventory = [];
        window.historyData = [];
        window.config = { categories: ["Inbox", "Kitchen", "Bar", "Office & Cleaning"], bins: ["Store"], accessCode: "1234" };
        window.activeCategory = "All";
        let isRegisterMode = false;
        let globalApiKey = localStorage.getItem('venueApiKey') || "";

        // --- AUTH ---
        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errEl = document.getElementById('auth-err');
            errEl.classList.add('hidden');
            try {
                if (isRegisterMode) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                if (e.code === 'auth/operation-not-allowed') {
                    errEl.textContent = "Error: Email login is not enabled in Firebase Console. Go to Auth > Sign-in Method to enable.";
                } else {
                    errEl.textContent = e.message;
                }
                errEl.classList.remove('hidden');
            }
        };

        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').textContent = isRegisterMode ? "Create Account" : "Venue Terminal";
            document.getElementById('auth-btn').textContent = isRegisterMode ? "Sign Up" : "Sign In";
            document.getElementById('auth-toggle').textContent = isRegisterMode ? "Back to Login" : "Create New Account";
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                setupListeners();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        // --- DATA ---
        const setupListeners = () => {
            onSnapshot(refs.inv(), (snap) => { if (snap.exists()) { window.inventory = snap.data().items || []; window.renderInventory(); window.updateStats(); window.updateFormSelects(); } });
            onSnapshot(refs.his(), (snap) => { if (snap.exists()) { window.historyData = snap.data().logs || []; window.updateStats(); } });
            onSnapshot(refs.cfg(), (snap) => { if (snap.exists()) { window.config = snap.data(); window.updateFormSelects(); window.renderCategoryTabs(); window.renderConfigLists(); } });
        };

        window.saveData = async (type = 'all') => {
            if (!auth.currentUser) return;
            try {
                if (type === 'all' || type === 'inventory') await setDoc(refs.inv(), { items: window.inventory });
                if (type === 'all' || type === 'history') await setDoc(refs.his(), { logs: window.historyData });
                if (type === 'all' || type === 'config') await setDoc(refs.cfg(), window.config);
            } catch (e) { window.showMsg("Cloud Save Error", "error"); }
        };

        window.renderInventory = () => {
            const list = document.getElementById('inventory-list');
            if(!list) return;
            const search = document.getElementById('search-bar').value.toLowerCase();
            const supFilter = document.getElementById('supplier-filter').value;
            list.innerHTML = '';

            const filtered = window.inventory.filter(i => {
                const matchSearch = i.name.toLowerCase().includes(search) || i.sku.toLowerCase().includes(search);
                const matchSup = supFilter === 'all' || i.supplier === supFilter;
                if (window.activeCategory === "Inbox") return i.needsReview && matchSearch && matchSup;
                if (i.needsReview) return false;
                const matchCat = window.activeCategory === "All" || i.category === window.activeCategory;
                return matchSearch && matchCat && matchSup;
            });

            document.getElementById('empty-state').classList.toggle('hidden', filtered.length > 0);
            const banner = document.getElementById('review-banner');
            if(banner) banner.classList.toggle('hidden', window.activeCategory !== "Inbox");

            filtered.sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
                const isLow = parseFloat(item.quantity) < parseFloat(item.reorderPoint);
                const li = document.createElement('li');
                li.className = `p-6 bg-white rounded-[2rem] border shadow-sm flex flex-col md:flex-row items-start md:items-center justify-between transition gap-4 ${isLow ? 'low-stock-row' : 'border-slate-100'}`;
                
                const infoDiv = document.createElement('div');
                const titleRow = document.createElement('div');
                titleRow.className = "flex items-center gap-2 mb-1";
                const nameS = document.createElement('span'); nameS.className = "font-black text-slate-800 uppercase text-sm italic"; nameS.textContent = item.name;
                const supS = document.createElement('span'); supS.className = "text-[7px] bg-slate-100 px-2 py-0.5 rounded-full font-black text-slate-400 uppercase"; supS.textContent = item.supplier || 'N/A';
                titleRow.append(nameS, supS);
                const metaRow = document.createElement('div'); metaRow.className = "text-[9px] text-slate-400 font-bold uppercase tracking-widest flex items-center gap-3 flex-wrap";
                metaRow.innerHTML = `<span>${item.bin}</span> ‚Ä¢ <span>Code: ${item.sku}</span> ‚Ä¢ <span class="text-blue-600 font-black">$${(parseFloat(item.unitCost) || 0).toFixed(2)} / ${item.uom || 'Unit'}</span>`;
                infoDiv.append(titleRow, metaRow);

                const acts = document.createElement('div'); acts.className = "flex items-center gap-3";
                acts.innerHTML = `<div class="flex items-center bg-slate-50 rounded-2xl p-1 font-black"><button onclick="window.adjStock('${item.id}', -1)" class="w-10 h-10 text-slate-400">-</button><span class="w-12 text-center text-xs">${parseFloat(item.quantity).toFixed(1)}</span><button onclick="window.adjStock('${item.id}', 1)" class="w-10 h-10 text-blue-600">+</button></div><button onclick="window.editItem('${item.id}')" class="text-slate-300 p-2 hover:text-blue-600 transition"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>`;
                li.append(infoDiv, acts); list.appendChild(li);
            });
        };

        // --- LOGIC: SCANNING & AI ---
        window.handleInvoiceUpload = async (event) => {
            if(!globalApiKey) return window.showMsg("Set Key in Settings", "error");
            const loader = document.getElementById('processing-indicator');
            loader.classList.remove('hidden');
            try {
                for (let file of event.target.files) {
                    const images = file.type === "application/pdf" ? await window.pdfToImages(file) : [await window.imgToBase64(file)];
                    for (let base64 of images) {
                        const result = await window.scanWithAI(base64);
                        result.items.forEach(item => {
                            const existing = window.inventory.find(i => i.sku === item.sku || i.name.toLowerCase() === item.name.toLowerCase());
                            const pSize = parseFloat(item.packSize) || 1;
                            const unitCost = Math.round((parseFloat(item.unitCost) / pSize) * 100) / 100;
                            const qtyAdded = (parseFloat(item.quantity) || 0) * pSize;
                            if (existing) {
                                existing.quantity = (parseFloat(existing.quantity) || 0) + qtyAdded;
                                existing.unitCost = unitCost || existing.unitCost;
                                existing.needsReview = true;
                                existing.lastScanInfo = { cases: parseFloat(item.quantity), pack: pSize, totalAdded: qtyAdded };
                            } else {
                                window.inventory.push({ id: crypto.randomUUID(), name: item.name, sku: item.sku || 'N/A', supplier: result.supplier || '', quantity: qtyAdded, unitCost: unitCost || 0, packSize: pSize, reorderPoint: 5, bin: window.config.bins[0], category: "Inbox", needsReview: true, uom: "Bottle", weeklyUsage: 0, lastScanInfo: { cases: parseFloat(item.quantity), pack: pSize, totalAdded: qtyAdded }, history: [] });
                            }
                        });
                    }
                }
                await window.saveData('inventory'); window.setCategory("Inbox"); window.showMsg("Batch Ready for Review");
            } catch (e) { window.showMsg("Scan Failed", "error"); } finally { loader.classList.add('hidden'); event.target.value = ''; }
        };

        window.scanWithAI = async (base64) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${globalApiKey}`;
            const prompt = "Extract invoice items JSON: { supplier, items: [{ name, sku, quantity, packSize, unitCost }] }. Forces unitCost to 2 decimal places.";
            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }]}], generationConfig: { responseMimeType: "application/json" } };
            const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
            const data = await res.json();
            return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
        };

        // --- BATCH REVIEW ---
        window.toggleBatchReview = () => {
            const modal = document.getElementById('batch-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) {
                const body = document.getElementById('batch-table-body');
                const items = window.inventory.filter(i => i.needsReview);
                body.innerHTML = items.map(i => `
                    <tr class="batch-row text-[10px] font-bold border-b border-slate-100">
                        <td class="p-4"><input type="text" value="${i.name}" onchange="window.updateBatchItem('${i.id}', 'name', this.value)" class="w-full border-none bg-transparent outline-none uppercase font-black"></td>
                        <td class="p-4">${i.sku}</td>
                        <td class="p-4"><input type="number" value="${i.packSize}" onchange="window.updateBatchItem('${i.id}', 'packSize', this.value)" class="w-16 p-1 border rounded"></td>
                        <td class="p-4"><select onchange="window.updateBatchItem('${i.id}', 'category', this.value)" class="w-full border rounded">${window.config.categories.map(c => `<option value="${c}" ${i.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></td>
                        <td class="p-4">$${parseFloat(i.unitCost).toFixed(2)}</td>
                        <td class="p-4 text-center"><button onclick="window.confirmBatchItem('${i.id}')" class="bg-emerald-500 text-white px-4 py-2 rounded-lg text-[8px] uppercase font-black">Process</button></td>
                    </tr>`).join('');
            }
        };
        window.updateBatchItem = (id, key, val) => { const i = window.inventory.find(x => x.id === id); if(i) i[key] = val; };
        window.confirmBatchItem = async (id) => { const i = window.inventory.find(x => x.id === id); if(i) { i.needsReview = false; if(i.category === "Inbox") i.category = window.config.categories[1] || "Misc"; await window.saveData('inventory'); window.toggleBatchReview(); window.toggleBatchReview(); } };

        // --- CORE UI HELPERS ---
        window.updateStats = () => {
            const val = window.inventory.reduce((acc, i) => acc + (parseFloat(i.quantity) * parseFloat(i.unitCost || 0)), 0);
            const setS = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
            setS('stat-value', `$${val.toLocaleString(undefined, {minimumFractionDigits: 2})}`);
            setS('stat-total', window.inventory.length);
            setS('stat-low', window.inventory.filter(i => parseFloat(i.quantity) < parseFloat(i.reorderPoint)).length);
            setS('stat-review', window.inventory.filter(i => i.needsReview).length);
        };

        window.editItem = (id) => {
            const i = window.inventory.find(x => x.id === id);
            if (!i) return;
            document.getElementById('edit-id').value = i.id;
            document.getElementById('item-name').value = i.name;
            document.getElementById('item-sku').value = i.sku;
            document.getElementById('item-supplier').value = i.supplier || "";
            document.getElementById('category-select').value = i.category;
            document.getElementById('bin-select').value = i.bin;
            document.getElementById('pack-size').value = i.packSize || 1;
            document.getElementById('unit-cost').value = i.unitCost || 0;
            document.getElementById('weekly-usage').value = i.weeklyUsage || 0;
            document.getElementById('reorder-point').value = i.reorderPoint || 5;
            document.getElementById('quantity').value = i.quantity || 0;
            document.getElementById('uom-select').value = i.uom || "Bottle";
            document.getElementById('expiry-date').value = i.expiry || "";
            document.getElementById('item-notes').value = i.notes || "";
            const helper = document.getElementById('math-helper-box');
            if (i.needsReview && i.lastScanInfo) { helper.classList.remove('hidden'); document.getElementById('math-helper-text').textContent = `AI: Found ${i.lastScanInfo.cases} x ${i.lastScanInfo.pack} pack = Added ${i.lastScanInfo.totalAdded} units.`; } else { helper.classList.add('hidden'); }
            document.getElementById('submit-btn').textContent = "Update Cloud";
            document.getElementById('cancel-edit').classList.remove('hidden');
            document.getElementById('delete-btn').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        document.getElementById('item-form').onsubmit = async (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const newItem = { id: editId || crypto.randomUUID(), name: document.getElementById('item-name').value, sku: document.getElementById('item-sku').value, supplier: document.getElementById('item-supplier').value, category: document.getElementById('category-select').value, bin: document.getElementById('bin-select').value, packSize: parseFloat(document.getElementById('pack-size').value) || 1, unitCost: Math.round(parseFloat(document.getElementById('unit-cost').value) * 100) / 100, weeklyUsage: parseFloat(document.getElementById('weekly-usage').value) || 0, reorderPoint: parseFloat(document.getElementById('reorder-point').value), quantity: parseFloat(document.getElementById('quantity').value), uom: document.getElementById('uom-select').value, expiry: document.getElementById('expiry-date').value, notes: document.getElementById('item-notes').value, needsReview: false, history: [] };
            if (editId) { window.inventory[window.inventory.findIndex(i => i.id === editId)] = newItem; } else window.inventory.push(newItem);
            await window.saveData('inventory'); window.cancelEdit();
        };

        window.deleteItem = async () => { const id = document.getElementById('edit-id').value; if (id && confirm("Delete product?")) { window.inventory = window.inventory.filter(i => i.id !== id); await window.saveData('inventory'); window.cancelEdit(); window.showMsg("Deleted"); } };

        window.exportData = () => {
            const cats = [...window.config.categories];
            const dataRows = cats.map(cat => {
                const items = window.inventory.filter(i => i.category === cat);
                if (items.length === 0) return "";
                let section = `--- CATEGORY: ${cat.toUpperCase()} ---\nName,SKU,Supplier,Cost,OnHand,Usage/Wk,Notes\n`;
                items.forEach(i => { section += `"${i.name}","${i.sku}","${i.supplier}",${i.unitCost},${i.quantity},${i.weeklyUsage || 0},"${i.notes || ''}"\n`; });
                return section;
            }).join("\n");
            const b = new Blob([dataRows], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup_${new Date().toISOString().split('T')[0]}.csv`; a.click();
        };

        window.updateFormSelects = () => {
            document.getElementById('category-select').innerHTML = window.config.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('bin-select').innerHTML = window.config.bins.map(b => `<option value="${b}">${b}</option>`).join('');
            const sups = [...new Set(window.inventory.map(i => i.supplier).filter(s => s))].sort();
            document.getElementById('supplier-list').innerHTML = sups.map(s => `<option value="${s}">`).join('');
            document.getElementById('supplier-filter').innerHTML = '<option value="all">All Suppliers</option>' + sups.map(s => `<option value="${s}">${s}</option>`).join('');
        };

        window.renderCategoryTabs = () => {
            const container = document.getElementById('category-tabs');
            if (!container) return;
            const cats = ["Inbox", "All", ...window.config.categories.filter(c => c !== "Inbox")];
            container.innerHTML = cats.map(c => `<button onclick="window.setCategory('${c}')" class="category-tab px-6 py-2 border border-slate-200 rounded-xl font-black text-[9px] uppercase transition ${window.activeCategory === c ? 'active bg-blue-600 text-white' : 'bg-white text-slate-400'} ${c === 'Inbox' ? 'review-tab' : ''}">${c}</button>`).join('');
        };

        window.addConfig = (type, inputId) => { const el = document.getElementById(inputId); if(el && el.value.trim()) { window.config[type].push(el.value.trim()); el.value = ""; window.saveData('config'); } };
        window.removeConfig = (type, val) => {
            if(type === 'categories' && confirm(`Rename or Remove ${val}? Items in this category will move to Inbox for re-assignment.`)) {
                window.inventory.forEach(i => { if(i.category === val) { i.category = "Inbox"; i.needsReview = true; } });
                window.saveData('inventory');
            }
            window.config[type] = window.config[type].filter(i => i !== val); window.saveData('config');
        };
        window.renderConfigLists = () => {
            document.getElementById('cat-config-list').innerHTML = window.config.categories.map(c => `<li class="flex justify-between p-2 bg-slate-50 rounded text-[9px] font-black uppercase"><span>${c}</span><button onclick="window.removeConfig('categories', '${c}')" class="text-red-400">‚úï</button></li>`).join('');
            document.getElementById('bin-config-list').innerHTML = window.config.bins.map(b => `<li class="flex justify-between p-2 bg-slate-50 rounded text-[9px] font-black uppercase"><span>${b}</span><button onclick="window.removeConfig('bins', '${b}')" class="text-red-400">‚úï</button></li>`).join('');
        };

        window.setCategory = (c) => { window.activeCategory = c; window.renderCategoryTabs(); window.renderInventory(); };
        window.adjStock = (id, amt) => { const i = window.inventory.find(x => x.id === id); if (i) { i.quantity = Math.max(0, (parseFloat(i.quantity) || 0) + amt); window.saveData('inventory'); } };
        window.toggleSettings = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.toggleStocktake = () => { const m = document.getElementById('stocktake-modal'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) document.getElementById('stocktake-list').innerHTML = window.inventory.sort((a,b) => a.bin.localeCompare(b.bin)).map(i => `<div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border"><div><div class="text-[8px] uppercase font-black text-slate-400">${i.bin}</div><div class="font-black text-xs uppercase">${i.name}</div></div><input type="number" id="st-${i.id}" placeholder="${i.quantity.toFixed(1)}" class="w-20 p-2 rounded-lg border font-black text-blue-600 outline-none"></div>`).join(''); };
        window.commitStocktake = async () => { window.inventory.forEach(i => { const el = document.getElementById(`st-${i.id}`); if (el && el.value !== "") i.quantity = parseFloat(el.value); }); await window.saveData('inventory'); window.toggleStocktake(); window.showMsg("Audit Sync Success"); };
        window.saveApiKey = () => { localStorage.setItem('venueApiKey', document.getElementById('api-key-input').value.trim()); window.showMsg("Key Saved"); location.reload(); };
        window.showMsg = (t, type = 'success') => { const b = document.getElementById('message-box'); b.textContent = t; b.className = `fixed top-8 right-8 p-6 rounded-2xl shadow-2xl text-[10px] font-black uppercase z-[250] ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white transition-all`; b.classList.remove('hidden'); setTimeout(() => b.classList.add('hidden'), 4000); };
        window.cancelEdit = () => { document.getElementById('item-form').reset(); document.getElementById('edit-id').value = ""; document.getElementById('submit-btn').textContent = "Save to Hobart Cloud"; document.getElementById('cancel-edit').classList.add('hidden'); document.getElementById('delete-btn').classList.add('hidden'); document.getElementById('math-helper-box').classList.add('hidden'); };
        window.imgToBase64 = async (f) => new Promise(r => { const rd = new FileReader(); rd.onload = e => r(e.target.result.split(',')[1]); rd.readAsDataURL(f); });
        window.pdfToImages = async (f) => { const pdf = await pdfjsLib.getDocument({ data: await f.arrayBuffer() }).promise; const images = []; for(let i=1; i<=pdf.numPages; i++) { const page = await pdf.getPage(i); const vp = page.getViewport({ scale: 2.0 }); const cvs = document.getElementById('pdf-render-canvas'); const ctx = cvs.getContext('2d'); cvs.height = vp.height; cvs.width = vp.width; await page.render({ canvasContext: ctx, viewport: vp }).promise; images.push(cvs.toDataURL('image/png', 0.8).split(',')[1]); } return images; };
        window.resetDatabase = async () => { if(confirm("Wipe all data?")) { window.inventory = []; await window.saveData(); location.reload(); } };
        window.generateReorderList = () => { const low = window.inventory.filter(i => parseFloat(i.quantity) < parseFloat(i.reorderPoint)); if (low.length === 0) return window.showMsg("Stock Healthy"); let list = `HOBART REORDER LIST - ${new Date().toLocaleDateString()}\n\n`; low.forEach(i => { list += `- ${i.name}: Need ${Math.ceil(i.reorderPoint - i.quantity)} ${i.uom}\n`; }); const ta = document.createElement('textarea'); ta.value = list; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); window.showMsg("Copied to Clipboard"); };

        window.onload = () => {
            const key = localStorage.getItem('venueApiKey');
            if (key) document.getElementById('api-key-input').value = key;
        };
    </script>
</body>
</html>